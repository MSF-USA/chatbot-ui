'use client';

import { Editor, loader } from '@monaco-editor/react';
import { IconLoader2 } from '@tabler/icons-react';
import { useRef, useState } from 'react';

import { useCodeEditorStore } from '@/client/stores/codeEditorStore';

// Configure Monaco to load from local node_modules instead of CDN
if (typeof window !== 'undefined') {
  loader.config({
    paths: {
      vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.54.0/min/vs',
    },
  });
}

interface CodeEditorProps {
  theme?: 'light' | 'dark';
}

export default function CodeEditor({ theme = 'light' }: CodeEditorProps) {
  const { modifiedCode, language, setModifiedCode } = useCodeEditorStore();

  const [isLoading, setIsLoading] = useState(true);
  const editorRef = useRef<any>(null);

  const handleEditorDidMount = (editor: any) => {
    console.log('Editor mounted', editor);
    editorRef.current = editor;
    setIsLoading(false);

    // Listen to changes
    editor.onDidChangeModelContent(() => {
      const newValue = editor.getValue();
      setModifiedCode(newValue);
    });
  };

  // Use vs-dark for dark theme, vs for light theme
  const monacoTheme = theme === 'dark' ? 'vs-dark' : 'vs';

  // Show placeholder when editor is empty
  const showPlaceholder = !modifiedCode;

  return (
    <div className="h-full w-full flex flex-col relative">
      {showPlaceholder && (
        <div className="absolute inset-0 flex items-center justify-center pointer-events-none z-10">
          <div className="text-center text-neutral-400 dark:text-neutral-500">
            <p className="text-lg mb-2">
              Start typing or ask AI to generate code
            </p>
            <p className="text-sm">
              Code will automatically sync from chat messages
            </p>
          </div>
        </div>
      )}

      <Editor
        height="100%"
        width="100%"
        defaultLanguage={language}
        defaultValue={modifiedCode || '// Start coding...'}
        theme={monacoTheme}
        onMount={handleEditorDidMount}
        onChange={(value) => {
          if (value !== undefined) {
            setModifiedCode(value);
          }
        }}
        loading={
          <div className="flex items-center justify-center h-full w-full bg-white dark:bg-neutral-900">
            <IconLoader2
              size={24}
              className="animate-spin text-neutral-900 dark:text-neutral-100"
            />
          </div>
        }
        options={{
          minimap: { enabled: false },
          fontSize: 14,
          lineNumbers: 'on',
          scrollBeyondLastLine: false,
          wordWrap: 'on',
          automaticLayout: true,
          tabSize: 2,
          insertSpaces: true,
          formatOnPaste: true,
          formatOnType: true,
          suggestOnTriggerCharacters: true,
          quickSuggestions: true,
          folding: true,
          foldingStrategy: 'indentation',
          showFoldingControls: 'always',
        }}
      />
    </div>
  );
}
