name: Build, Test, and Push Docker Image

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

env:
  # Logic: If it's a push to main, use 'prod' settings for the image build, otherwise use 'dev' for PRs.
  ENV_TYPE: ${{ (github.event_name == 'push' && github.ref == 'refs/heads/main' && 'prod') || 'dev' }}
  REGISTRY_NAME: ${{ (github.event_name == 'push' && github.ref == 'refs/heads/main' && 'msfintlnycprodai') || 'msfintlnycdevai' }}
  IMAGE_NAME: ${{ (github.event_name == 'push' && github.ref == 'refs/heads/main' && 'ai-assistant') || 'ai-assistant-dev' }}

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Log in to Azure Container Registry
        run: az acr login --name ${{ env.REGISTRY_NAME }}

      - name: Build test stage and extract coverage report
        run: |
          docker buildx build \
            --target test \
            --output type=local,dest=./coverage \
            .

      - name: Archive full coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: ./coverage/

      - name: Generate coverage comment body
        id: coverage-comment
        if: github.event_name == 'pull_request'
        run: |
          # This step uses 'jq' to parse the JSON summary and constructs a markdown body
          JSON_PATH="./coverage/coverage-summary.json"

          # Extract coverage percentages
          LINES=$(jq -r '.total.lines.pct' $JSON_PATH)
          FUNCTIONS=$(jq -r '.total.functions.pct' $JSON_PATH)
          BRANCHES=$(jq -r '.total.branches.pct' $JSON_PATH)

          # Construct the link to the uploaded artifact
          ARTIFACT_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Use a HEREDOC to create the multi-line comment body
          COMMENT_BODY=$(cat <<EOF
          ### Vitest Code Coverage

          | Category  | Coverage |
          |-----------|:--------:|
          | Lines     |  \`$LINES%\`   |
          | Functions |  \`$FUNCTIONS%\` |
          | Branches  |  \`$BRANCHES%\` |

          [View Full HTML Report (expires in 90 days)]($ARTIFACT_URL)
          EOF
          )

          # Use GITHUB_OUTPUT to pass the multi-line body to the next step
          echo "comment_body<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMENT_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post or Update coverage comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            // Search for an existing comment by this Action to update it
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' && comment.body.includes('Vitest Code Coverage')
            );
            const commentBody = `${{ steps.coverage-comment.outputs.comment_body }}`;

            if (botComment) {
              github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=ref,event=pr,prefix=pr-

      # This step pushes for BOTH PRs (to dev ACR) and merges to main (to prod ACR)
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
